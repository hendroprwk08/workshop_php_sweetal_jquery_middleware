<html>
    <head>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
        <meta content="utf-8" http-equiv="encoding">   

        <script src="js/jquery-3.4.0.js"></script>
        <script src="js/sweetalert2.all.min.js"></script>
        <style>
            .container{
                width: 100%;        
            }
        </style>
    </head>
    <body>
        <div class="container">   
            <h1>Data Barang</h1>    
            <small>ID Otomatis, tak perlu input</small><br>  
            <label>Nama</label><br>           
            <input type="text" id="nama"><br>
            <label>Jenis</label><br>
                <select id="jenis">
                    <option value="Makanan">Makanan</option>
                    <option value="Minuman">Minuman</option>
                    <option value="Perabot">Perabot</option>
                    <option value="Perkakas">Perkakas</option>
                    <option value="Per. Mandi">Per. Mandi</option>
                </select><br>
            <label>Stok</label><br>           
            <input type="text" id="stok"><br>
            <button id="simpan">Simpan</button>
            <p id="loader"><img src="assets/loader.gif"></p>
            <table border="1">
                <tr>
                    <td>Nama</td>
                    <td>Jenis</td>
                    <td>Stok</td>
                    <td>&nbsp;</td>
                </tr>
            </table>
        </div>   
        <script type="text/javascript">
            $(document).ready(function ()
            {
                var myUrl, base_url = "http://localhost/workshop_php_sweetal_jquery_middleware/";
                var id, nama, jenis, stok, input;

                $("#loader").hide();
                loadGrid();

               function loadGrid(){
                    myUrl = base_url + "op.php?act=4";
                    //console.log(myUrl);
                   $.ajax({
                        url: myUrl, 
                        dataType: "json",
                        beforeSend:function(){
                            $("#loader").fadeIn();
						},
                        success: function(result){ 
                            //console.log("table"+ result);
                            var rows, json = result.hasil; //ambil object hasil
                            
                            //ambil pesan dari json
                            $.each(json, function(key, val){
                                //console.log(key + " " + val.nama + " " + val.jenis + " " + val.stok);
                                rows += "<tr id="+ val.id +"><td>"+ val.nama +"</td><td>"+ val.jenis +"</td><td>"+ val.stok +"</td>";
                                rows += "<td><a class='ubah' id="+ val.id +" href='#'>Ubah</a> <a class='hapus' id="+ val.id +" href='#'>Hapus</a></td></tr>";
                            });

                            $("table").append(rows);
                            $("#loader").fadeOut();

                            $(".ubah").click(function(){
                                var id = this.id; 
                                alert(id);
                            });

                            $(".hapus").click(function(){
                                var id = this.id; 
                               
                                Swal.fire({
                                    title: "Konfirmasi",
                                    text: "Data yang telah dihapus tak dapat dikembalikan",
                                    type:"warning",
                                    showCancelButton: true,
                                    confirmButtonText: "Hapus data",
                                })

                                .then((result) =>{
                                    console.log(base_url + "op.php?act=3&id"+id);

                                    if (result){
                                        $.ajax({
                                            url: base_url + "op.php?act=3&id="+id,
                                            dataType: "json",
                                            success: function(result){
                                                var obj = result.hasil; //ambil object hasil
                                                var psn;

                                                //ambil pesan dari json
                                                $.each(obj, function(key, val){
                                                    console.log("key val "+ key + " " + val.pesan);
                                                    psn = val.pesan;
                                                });

                                                Swal.fire("Konfirmasi", psn, "success");

                                                //hapus baris terpilih    
                                                $("table tr#"+id).fadeOut();
                                            }
                                        });
                                    }else{
                                        Swal.fire("Penghapusan data dibatalkan");
                                    }
                                });
                            });
                        },

                        fail: function(xhr, textStatus, errorThrown){
                            Swal.fire({
                                type: 'error',
                                title: textStatus,
                                text: errorThrown,
                                footer: ''
                            });
                        }
                    });  
                };

                function execute(page, sql){

                }
                //ketika tombol klik ditekan maka akan menjalankan ajax
                $("#simpan").click(function(){
                    var nama = $("#nama").val();
                    var jenis = $("#jenis").val();
                    var stok = $("#stok").val();
                  
                    if (nama.length == 0 || stok.length == 0){
                        Swal.fire("Perhatian", "Lengkapi nama barang, jenis dan stok", "info");
                        return;
                    }        

                    //simpan kedalam database melalui PHP
                    myUrl = base_url + "op.php?act=1&nm="+nama+"&jn="+jenis+"&st="+stok;
                    console.log(myUrl);

                    $.ajax({
                        url: myUrl, 
                        dataType: "json",
                        beforeSend:function(){
                            $("#submit").attr("disabled", true);
                            $("#loader").fadeIn();
						},
                        success: function(result){ 
                            console.log(result);
                            var psn;
                            
                            //ambil pesan dari json
                            $.each(result.hasil, function(key, val){
                                console.log("key val "+ key + " " + val.pesan);
                                psn = val.pesan;
                            });

                            //kosongkan
                            $("#nama").val("");
                            $("#jenis").selectedIndex = 0;
                            $("#stok").val("");

                            loadGrid();

                            $("#submit").attr("disabled", false);
                            $("#loader").fadeOut();
                        },

                        fail: function(xhr, textStatus, errorThrown){
                            Swal.fire(textStatus, errorThrown, "error");
                            $("#submit").attr("disabled", false);
                        }
                    });  

                });
            });
        </script>
    </body>
</html>